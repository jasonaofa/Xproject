# 美术资源管理工具 - 打包部署指南

## 问题解决方案

### 原问题：PIL依赖缺失
```
🖼️ 图片尺寸问题 (1个)
----------------------------------------
  1. 【image_read_error】
     文件: wuqi.png
     问题: 无法读取图片: No module named 'PIL'
```

### 解决方案

我们提供了两种解决方案：

## 方案1：完整依赖打包（推荐）

### 1. 安装所有依赖
```bash
pip install PyQt5 PyYAML Pillow pyinstaller
```

### 2. 使用自动打包脚本
```bash
python build_exe.py
```

这个脚本会：
- 自动检查依赖
- 安装PyInstaller（如果需要）
- 构建单文件EXE
- 创建完整的分发包

### 3. 分发给同事
将 `distribution/` 文件夹整个发给同事，包含：
- `美术资源管理工具.exe` - 主程序
- `使用说明.txt` - 使用文档
- `启动工具.bat` - 快速启动脚本

## 方案2：内置图片读取（无需PIL）

### 技术实现
代码已经修改为支持双重检测：
1. **优先使用PIL**：如果环境中有PIL库，使用PIL读取图片
2. **降级到内置方法**：如果没有PIL，使用Python内置方法解析PNG和JPEG

### 支持的格式
- **PNG格式**：解析IHDR chunk获取尺寸
- **JPEG格式**：解析SOF marker获取尺寸
- **其他格式**：跳过检查，提示手动验证

### 错误处理
- `image_read_error`：读取过程中的异常
- `image_read_skip`：无法读取时跳过检查
- `oversized_image`：成功读取且尺寸超限

## 手动打包步骤

如果不使用自动脚本，可以手动执行：

### 1. 安装PyInstaller
```bash
pip install pyinstaller
```

### 2. 基础打包命令
```bash
pyinstaller --onefile --windowed --name=美术资源管理工具 art_resource_manager.py
```

### 3. 完整打包命令（推荐）
```bash
pyinstaller --onefile --windowed --name=美术资源管理工具 ^
    --hidden-import=PyQt5.sip ^
    --hidden-import=PIL._tkinter_finder ^
    --add-data=config.json;. ^
    art_resource_manager.py
```

### 4. 打包参数说明
- `--onefile`：打包成单个EXE文件
- `--windowed`：Windows下隐藏控制台窗口
- `--name`：指定生成的EXE文件名
- `--hidden-import`：包含可能遗漏的模块
- `--add-data`：包含数据文件

## 部署最佳实践

### 1. 测试环境
在干净的Windows机器上测试EXE，确保：
- 无需安装Python
- 无需安装任何依赖
- 所有功能正常工作

### 2. 文件结构
```
distribution/
├── 美术资源管理工具.exe    # 主程序
├── 使用说明.txt           # 用户手册
└── 启动工具.bat           # 可选的启动脚本
```

### 3. 版本管理
- 在EXE文件名中包含版本号
- 保留旧版本以备回滚
- 记录每个版本的功能变更

### 4. 分发方式
- **内网共享**：放在共享文件夹
- **邮件分发**：压缩后发送
- **版本控制**：使用Git LFS管理二进制文件

## 常见问题解决

### Q1: 打包后EXE很大（>100MB）
**A**: 这是正常的，因为包含了完整的Python运行时和所有依赖。

### Q2: 启动速度慢
**A**: 第一次启动会解压临时文件，后续启动会快一些。

### Q3: 杀毒软件误报
**A**: 将EXE添加到杀毒软件白名单，或使用代码签名证书。

### Q4: 在某些机器上无法运行
**A**: 确保目标机器是Windows 7+，并安装了Visual C++ Redistributable。

## 图片尺寸检查功能说明

### 支持情况
| 格式 | PIL可用时 | PIL不可用时 | 说明 |
|------|-----------|-------------|------|
| PNG  | ✅ 完全支持 | ✅ 内置支持 | 解析IHDR chunk |
| JPEG | ✅ 完全支持 | ✅ 内置支持 | 解析SOF marker |
| GIF  | ✅ 完全支持 | ❌ 跳过检查 | 建议手动检查 |
| BMP  | ✅ 完全支持 | ❌ 跳过检查 | 建议手动检查 |
| TGA  | ✅ 完全支持 | ❌ 跳过检查 | 建议手动检查 |

### 检查结果说明
- **oversized_image**：图片尺寸超过1024x1024
- **image_read_skip**：无法读取尺寸，建议手动检查
- **image_read_error**：读取过程出错，可能文件损坏

这样的设计确保了即使在没有PIL库的环境中，工具仍然可以正常工作，并且能够处理最常见的PNG和JPEG格式图片。 